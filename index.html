<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
  <title>App Viagem Madrid</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f5f5f5; color: #333; display: flex; flex-direction: column; min-height: 100vh; }
    header { background: linear-gradient(135deg, #e53935, #c62828); color: #fff; padding: 1.5rem; text-align: center; position: sticky; top: 0; z-index: 20; }
    header h1 { font-size: 1.75rem; margin-bottom: 0.25rem; }
    header p { font-size: 1rem; }
    nav.main-nav { position: fixed; bottom: 0; left: 0; right: 0; background: #e53935; display: flex; justify-content: space-around; padding: 0.5rem 0; z-index: 20; box-shadow: 0 -2px 4px rgba(0,0,0,0.2); }
    nav.main-nav button { background: none; border: none; color: #fff; font-size: 1.2rem; flex: 1; padding: 0.5rem; cursor: pointer; }
    nav.main-nav button.active, nav.main-nav button:hover { background: #b71c1c; }
    main { flex: 1; overflow-y: auto; padding: 1rem; margin-bottom: 4rem; }
    .section { display: none; animation: fadeIn 0.4s ease; }
    .section.active { display: block; }
    h2 { text-align: center; color: #c62828; margin-bottom: 1rem; }
    .card { background: #fff; border-radius: 12px; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .grid { display: grid; gap: 1rem; }
    .grid-2 { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
    .btn { display: inline-block; width: 100%; padding: 0.75rem; border-radius: 8px; background: #c62828; color: #fff; font-size: 1rem; margin-top: 0.5rem; text-align: center; border: none; text-decoration: none; }
    .btn:hover { background: #b71c1c; cursor: pointer; }
    select { width: 100%; padding: 0.75rem; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem; margin-bottom: 1rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; }
    th, td { padding: 0.75rem; border: 1px solid #ddd; font-size: 0.9rem; text-align: left; }
    th { background: #f0f0f0; }

    /* Modal and Carousel Styles from index.html */
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; visibility: hidden; opacity: 0; transition: opacity 0.3s; z-index: 30;}
    .modal.active { visibility: visible; opacity: 1; }
    .modal-content { background: #fff; padding: 1rem; border-radius: 12px; max-width: 90%; max-height: 90%; overflow: hidden; /* Changed from auto to hidden for carousel */ }
    /* img, iframe styles are overridden by carousel below if needed */
    .close-btn { background: #c62828; color: #fff; border: none; padding: 0.5rem 1rem; border-radius: 4px; margin-top: 0.5rem; cursor: pointer; }

    #carouselContainer {
      display: flex;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      gap: 1rem;
      padding-bottom: 1rem;
      margin-bottom: 1rem;
    }
    #carouselContainer > div {
      flex: 0 0 100%;
      scroll-snap-align: start;
    }
    #carouselContainer::-webkit-scrollbar {
      display: none;
    }
    #carouselContainer {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    /* Ensure images inside carousel are responsive */
    #carouselContainer img {
      width: 100%;
      height: auto;
      border-radius: 8px;
    }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body>
  <header>
    <h1>🇪🇸 Vamos a <strong>Madrid 🇪🇸</strong></h1>
    <p>🗺️ Vamos Viajar 2025 🗺️</p>
  </header>

  <main>
    <section id="dashboard" class="section active">
      <h2>Dashboard</h2>
      <div class="card grid grid-2">
        <div>
          <p>📅<strong><span id="dateMadrid">--/--/----</span></strong></p><br>
          <p>🇪🇸: <strong><span id="timeMadrid">--:--</span></strong></p><br>
          <p>🇵🇹: <strong><span id="timePortugal">--:--</span></strong></p>
        </div>
        <div>
          <p>🌡️<strong><span id="weather">--</span></strong></p>
        </div>
      </div>
      <div class="card">
        <h3>Agenda de Hoje</h3>
        <div style="max-height:200px;overflow-y:auto;">
          <table>
            <thead><tr><th>Hora</th><th>Atividade</th></tr></thead>
            <tbody id="todayTable">
                <tr><td colspan="2">A carregar agenda...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="itinerario" class="section">
      <h2>Itinerário</h2>
      <div class="card">
        <select id="diaSelect">
          <option value="quinta">Quinta</option>
          <option value="sexta">Sexta</option>
          <option value="sábado">Sábado</option>
          <option value="domingo">Domingo</option>
        </select>
        <div id="diaConteudo"></div>
      </div>
    </section>

    <section id="bilhetes" class="section">
      <h2>Minhas Reservas</h2>
      <div class="grid grid-2" id="ticketContainer"></div>
    </section>

    <section id="shortcuts" class="section">
      <h2>Locais</h2>
      <div class="grid grid-2">
        <button class="btn" onclick="openMaps('Novotel Campo De Las Naciones')">🏨 Hotel</button>
        <button class="btn" onclick="openMaps('38.702081, -9.424852')">🏠 Casa</button>
        <button class="btn" onclick="openMaps('MVMX+WR Olivença, Espanha')">🥐 Cafetaria - Olivença</button>
        <button class="btn" onclick="openMaps('Takos Al Pastor')">🌮 Takos Al Pastor</button>
        <button class="btn" onclick="openMaps('C. Alcañiz, 5, Barajas, 28042 Madrid, Espanha')">🛒 Mercadona</button>
        <button class="btn" onclick="openMaps('Campo de las Naciones, Av. de los Andes, 46, Hortaleza, 28042 Madrid, Espanha')">🍔 Mc'Donalds</button>
        <button class="btn" onclick="openMaps('Parque Warner')">🎢 Parque Warner Bros.</button>
        <button class="btn" onclick="openMaps('C. de Colón, 13, Centro, 28004 Madrid, Espanha')">🥘 La Ardosa</button>
        <button class="btn" onclick="openMaps('Plaza Mayor - Madrid')">🏙️ Plaza Mayor</button>
        <button class="btn" onclick="openMaps('Mercado San Miguel - Madrid')">🏙️ Mercado de São Miguel</button>
        <button class="btn" onclick="openMaps('Templo de Debod - Madrid')">🏙️ Templo de Debod</button>
        <button class="btn" onclick="openMaps('Restaurante Arte y Paladar')">🥘 Restaurante Arte y Paladar</button>
        <button class="btn" onclick="openMaps('Oxo Museo Del Videojuego Madrid')">🎮 OXO Video Games Museum</button>
      </div>
    </section>
  </main>

  <nav class="main-nav">
    <button onclick="showSection('dashboard')" class="active">🏠</button>
    <button onclick="showSection('itinerario')">🗓️</button>
    <button onclick="showSection('shortcuts')">📍</button>
  </nav>

  <div id="ticketModal" class="modal">
    <div class="modal-content">
      <h3 id="modalTitle"></h3>
      <div id="carouselContainer"></div>
      <a id="fullLink" href="#" target="_blank" class="btn">Ver Completo</a>
      <button class="close-btn" onclick="closeModal()">Fechar</button>
    </div>
  </div>

  <script>
    // Navegação
    function showSection(id) {
      document.querySelectorAll('main .section').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelectorAll('nav.main-nav button').forEach(b => b.classList.remove('active'));
      document.querySelector(`nav.main-nav button[onclick*="${id}"]`).classList.add('active');
    }
    // Ir para hotel
    function goHotel() {
      openMaps('Travelodge Madrid Metropolitano');
    }

    // --- FIX 1: Abrir maps ---
    // O URL estava incorreto e a sintaxe para inserir a variável também.
    function openMaps(dest) {
      const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(dest)}`;
      window.open(url, '_blank');
    }

    // --- FIX 2: Data & Hora (Refatorado para robustez) ---
    // Criamos um único objeto Date e depois formatamos para data e hora.
    function updateDateTime() {
      const options = { timeZone: 'Europe/Madrid' };
      const dt = new Date();
      document.getElementById('dateMadrid').textContent = dt.toLocaleDateString('pt-PT', options);
      document.getElementById('timeMadrid').textContent = dt.toLocaleTimeString('pt-PT', options);
    }
    function updateDateTime2() {
      const options = { timeZone: 'Europe/Lisbon' };
      const dt = new Date();
      document.getElementById('timePortugal').textContent = dt.toLocaleTimeString('pt-PT', options);
    }
    setInterval(updateDateTime, 1000);
    updateDateTime();

    setInterval(updateDateTime2, 1000);
    updateDateTime2();

    // Countdown até partida (código original estava OK)
   

    // Clima (código original estava OK)
    fetch('https://api.open-meteo.com/v1/forecast?latitude=40.4168&longitude=-3.7038&current_weather=true')
      .then(r => r.json()).then(data => {
        const w = data.current_weather;
        document.getElementById('weather').textContent = `${w.temperature}°C`;
      }).catch(() => document.getElementById('weather').textContent = 'N/A');

    // Itinerário e Agenda
    const dias = {
      quinta: [
        {hora:'05:00 (🇵🇹)', atividade:'Acordar'},
        {hora:'06:00 (🇵🇹)', atividade:'Partida'},
        {hora:'09:00 (🇪🇸)', atividade:'Chega à Fronteira'},
        {hora:'10:00 (🇪🇸)', atividade:'Cafetaria Pastelaria A Chaminé'},
        {hora:'14:00 (🇪🇸)', atividade:'Almoço - Al Takos Pastor'},
        {hora:'15:45 (🇪🇸)', atividade:'Check-in - Hotel'},
        {hora:'17:00 (🇪🇸)', atividade:'Ida ao Mercadona'},
        {hora:'18:10 (🇪🇸)', atividade:'Chegada ao Hotel'},
        {hora:'18:45 (🇪🇸)', atividade:'Ida á piscina'},
        {hora:'20:00 (🇪🇸)', atividade:"Jantar - Mc'Donalds"},
        {hora:'21:20 (🇪🇸)', atividade:'Descanço'}
      ],
      sexta: [
        {hora:'09:00 (🇪🇸)', atividade:'Acordar'},
        {hora:'09:00/11:30 (🇪🇸)', atividade:'Pequeno Almoço'},
        {hora:'10:30 (🇪🇸)', atividade:'Preparação para o Parque'},
        {hora:'12:00 (🇪🇸)', atividade:'Chegada ao Parque'},
        {hora:'20:00 (🇪🇸)', atividade:'Saida do Parque'},
        {hora:'20:40 (🇪🇸)', atividade:'Jantar - La Ardosa'},
        {hora:'22:00 (🇪🇸)', atividade:'Descanço'}
      ],
      // --- FIX 3: Corrigido 'sabado' para 'sábado' para corresponder ao nome do dia da semana ---
      sábado: [
        {hora:'09:00 (🇪🇸)', atividade:'Acordar'},
        {hora:'09:20/11:30 (🇪🇸)', atividade:'Pequeno Almoço'},
        {hora:'10:45 (🇪🇸)', atividade:'Plaza Mayor'},
        {hora:'11:20 (🇪🇸)', atividade:'Mercado de São Miguel'},
        {hora:'13:30 (🇪🇸)', atividade:'Templo de Debod'},
        {hora:'15:00 (🇪🇸)', atividade:'Almoço - Arte y Paladar'},
        {hora:'16:15 (🇪🇸)', atividade:'OXO Video Game Museum'},
        {hora:'18:50 (🇪🇸)', atividade:'Chegada ao Hotel'},
        {hora:'19:30 (🇪🇸)', atividade:'Preparar as Malas'},
        {hora:'20:00 (🇪🇸)', atividade:'Jantar'},
        {hora:'21:20 (🇪🇸)', atividade:'Descanço'}
      ],
      domingo:[
      
        {hora:'09:00 (🇪🇸)', atividade:'Acordar'},
        {hora:'09:20/11:30 (🇪🇸)', atividade:'Pequeno Almoço'},
        {hora:'11:30 (🇪🇸)', atividade:'Preparar para viagem'},
        {hora:'12:00 (🇪🇸)', atividade:'Check-Out'},
        {hora:'12:20 (🇪🇸)', atividade:'Partida'},
        {hora:'15:00 (🇪🇸)', atividade:'Lanche Rápido'},
        {hora:'16:00 (🇵🇹)', atividade:'Chegada à Fronteira'},
        {hora:'17:40 (🇵🇹)', atividade:'Chegada'}
      
      ],
      
    };

    const sel = document.getElementById('diaSelect'), cont = document.getElementById('diaConteudo');

    // Função auxiliar para criar links para locais específicos
    function mapLink(act) {
      const locaisComLink = [
        'Novotel Campo De Las Naciones', '38.702081, -9.424852', 'MVMX+WR Olivença, Espanha', 'Takos Al Pastor',
        'C. Alcañiz, 5, Barajas, 28042 Madrid, Espanha', 'Campo de las Naciones, Av. de los Andes, 46, Hortaleza, 28042 Madrid, Espanha',
        'Parque Warner', 'C. de Colón, 13, Centro, 28004 Madrid, Espanha', 'Plaza Mayor - Madrid',
        'Mercado San Miguel - Madrid', 'Templo de Debod - Madrid', 'Restaurante Arte y Paladar',
        'Oxo Museo Del Videojuego Madrid', 'Travelodge Madrid Metropolitano', 'Puerta del Sol', 'Museu Reina Sofia', 'Parque Retiro'
      ];
      // Check if the activity string contains any of the known locations
      for (const location of locaisComLink) {
        if (act.includes(location)) {
          return `<a href="#" onclick="event.preventDefault(); openMaps('${location}')">${act}</a>`;
        }
      }
      return act;
    }

    // Renderiza o itinerário para o dia selecionado
    function renderItinerario(dia) {
      let html = '<table><thead><tr><th>Hora</th><th>Atividade</th></tr></thead><tbody>';
      if (dias[dia] && dias[dia].length > 0) {
        dias[dia].forEach(item => {
          html += `<tr><td>${item.hora}</td><td>${mapLink(item.atividade)}</td></tr>`;
        });
      } else {
        html += '<tr><td colspan="2">Sem atividades planeadas.</td></tr>';
      }
      cont.innerHTML = html + '</tbody></table>';
    }
    sel.addEventListener('change', () => renderItinerario(sel.value));

    // --- FUNÇÃO CORRIGIDA: Agenda do dia (dashboard) baseada no horário local ---
    function summaryToday() {
      const today = new Date(); // Objeto Date baseado na hora LOCAL do seu dispositivo
      const options = { weekday: 'long' }; // Sem timeZone para usar o local do dispositivo
      
      // Obtém o nome completo do dia da semana em português, no fuso horário LOCAL
      let dayFullName = today.toLocaleDateString('pt-PT', options).toLowerCase(); 

      // Remove "-feira" para corresponder às chaves do objeto `dias`
      let day = dayFullName.replace('-feira', '');

      // --- Mensagens de Depuração ---
      console.log('--- Debugging summaryToday (Local Time) ---');
      console.log('Objeto Date bruto (hora do seu dispositivo):', today);
      console.log('Nome completo do dia (fuso horário LOCAL):', dayFullName);
      console.log('Dia calculado para a chave da agenda:', day);
      console.log('-----------------------------------------');
      // --- Fim das Mensagens de Depuração ---

      const rows = dias[day] || [];
      const tb = document.getElementById('todayTable');

      // Atualiza o <select> do itinerário para o dia de hoje
      sel.value = day;
      renderItinerario(day); // Renderiza o itinerário inicial

      if (rows.length > 0) {
        tb.innerHTML = ''; // Limpa a tabela
        // Usamos a função mapLink para criar links também na agenda do dia
        rows.forEach(item => tb.innerHTML += `<tr><td>${item.hora}</td><td>${mapLink(item.atividade)}</td></tr>`);
      } else {
        tb.innerHTML = '<tr><td colspan="2">Sem atividades para hoje.</td></tr>';
      }
    }
    summaryToday();

    // Tickets data - combined and adapted for new structure
    const tickets = [
      {
        title: 'Warner',
        files: [
          { preview: './bilhetes/warner/qr1.png', full: 'https://github.com/evinun/app-viagem-madrid/raw/main/bilhetes/warner.pdf' }, // Adjusted path/URL
          { preview: 'bilhetes/warner/qr2.png', full: 'https://github.com/evinun/app-viagem-madrid/raw/main/bilhetes/warner.pdf' }, // Assuming these link to the same full PDF for Warner
          { preview: 'bilhetes/warner/qr3.png', full: 'https://github.com/evinun/app-viagem-madrid/raw/main/bilhetes/warner.pdf' },
          { preview: 'bilhetes/warner/qr4.png', full: 'https://github.com/evinun/app-viagem-madrid/raw/main/bilhetes/warner.pdf' }
        ],
        info: '2 adultos, 1 infantil', // Added from v1.html
        date: '08/08/2025' // Added from v1.html
      },
      {
        title: 'Sweet Space',
        files: [
          { preview: 'https://github.com/evinun/app-viagem-madrid/raw/main/bilhetes/sweet-space.jpeg', full: 'https://github.com/evinun/app-viagem-madrid/raw/main/bilhetes/sweet-space.jpeg' }
        ],
        info: '3 ingressos', // Added from v1.html
        date: '09/08/2025' // Added from v1.html
      },
      {
        title: 'Hotel',
        files: [
          { preview: 'bilhetes/hotel/qr.png', full: 'https://github.com/evinun/app-viagem-madrid/raw/main/bilhetes/hotel.pdf' } // Assuming a preview image exists
        ],
        info: '3 noites', // Added from v1.html
        date: '07/08/2025' // Added from v1.html
      },
      {
        title: 'Carro',
        files: [
          { preview: 'bilhetes/carro/qr.png', full: 'https://github.com/evinun/app-viagem-madrid/raw/main/bilhetes/carro.pdf' } // Assuming a preview image exists
        ],
        info: '4 dias', // Added from v1.html
        date: '07/08/2025' // Added from v1.html
      }
    ];

    const ticketCont = document.getElementById('ticketContainer');
    tickets.forEach(t => { // Iterating directly over t as it now contains all info
      const c = document.createElement('div');
      c.className = 'card';
      c.innerHTML = `        <h3>🎟️ ${t.title}</h3>
        <p>${t.info} • ${t.date}</p>
        <button class="btn" onclick="openTicket('${t.title}')">Abrir</button>
      `;      ticketCont.appendChild(c);
    });

    function openTicket(title) {
      const ticket = tickets.find(t => t.title === title);
      const container = document.getElementById('carouselContainer');
      container.innerHTML = ''; // Clear previous content
      document.getElementById('modalTitle').textContent = ticket.title;

      ticket.files.forEach((file, i) => {
        const slide = document.createElement('div');
        slide.dataset.full = file.full; // Store the full URL for the link

        const ext = file.preview.split('.').pop().toLowerCase();
        if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) {
          const img = document.createElement('img');
          img.src = file.preview;
          img.alt = `Ticket preview ${i + 1}`;
          slide.appendChild(img);
        } else {
          // Fallback for non-image previews (e.g., if a PDF is directly linked as preview)
          // You might want to display a generic icon or message for PDFs
          slide.innerHTML = `<p style="text-align:center; padding: 20px;">Preview não disponível. <br> <a href="${file.full}" target="_blank">Abrir ficheiro completo</a>.</p>`;
        }

        const caption = document.createElement('p');
        caption.textContent = `Ficheiro ${i + 1} de ${ticket.files.length}`;
        caption.style.marginTop = '0.5rem';
        caption.style.textAlign = 'center';
        slide.appendChild(caption);

        container.appendChild(slide);
      });

      updateFullLinkFromVisibleSlide(); // Set initial link
      document.getElementById('ticketModal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('ticketModal').classList.remove('active');
    }

    function updateFullLinkFromVisibleSlide() {
      const container = document.getElementById('carouselContainer');
      const slides = Array.from(container.children);
      if (slides.length === 0) { // Handle case with no slides
          document.getElementById('fullLink').href = '#';
          return;
      }

      // Calculate which slide is currently most visible
      let closestSlide = slides[0];
      let minDiff = Infinity;

      // The scrollLeft property indicates the number of pixels an element's content is scrolled to the left.
      // We are looking for the slide whose offsetLeft (position relative to its parent container)
      // is closest to the scrollLeft of the container.
      const containerScrollLeft = container.scrollLeft;
      const containerWidth = container.offsetWidth;

      slides.forEach(slide => {
          const slideLeft = slide.offsetLeft;
          const slideRight = slideLeft + slide.offsetWidth;

          // Check if the slide is significantly within the view
          // A simple approach: if the middle of the slide is in the view.
          // Or, calculate overlap. For simplicity, we'll check closeness to scrollLeft.
          if (slide.offsetLeft >= containerScrollLeft && slide.offsetLeft < (containerScrollLeft + containerWidth)) {
            const diff = Math.abs(slide.offsetLeft - containerScrollLeft);
            if (diff < minDiff) {
              minDiff = diff;
              closestSlide = slide;
            }
          }
      });
      document.getElementById('fullLink').href = closestSlide.dataset.full;
    }

    // Event listener for scroll to update the full link
    document.getElementById('carouselContainer').addEventListener('scroll', () => {
      clearTimeout(window._scrollTimer);
      window._scrollTimer = setTimeout(updateFullLinkFromVisibleSlide, 100);
    });
  </script>
</body>
</html>
